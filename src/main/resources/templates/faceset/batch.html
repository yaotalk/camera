	<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="layout/layout" >
   		<div layout:fragment="sidebar" th:replace="layout/sidebar">
		</div>
		<div layout:fragment="content" th:fragment="content">
			<!-- <div th:replace="fragments :: navbar"></div> -->
			<!-- <h1 layout:fragment="page-header">Messages : View all</h1> -->
			<div class="page-header">
				<h1>批量注册 </h1>
			</div>
			
			<div class="row">
				<div class="col-sm-6" th:hidden="${task} != null" id="new_task_form">
					<form class="form-horizontal" id="import_form" action="createTask" method="post">
						<div class="form-group">
						    <label for="faceset" class="col-sm-2 control-label">人脸库</label>
						    <div class="input-group col-sm-6">
						      <select  class="form-control" id="faceset"  name="faceSetToken" required="required">
						      </select>
						    </div>
						  </div>
					
						<div class="form-group">
							<label for="faceset" class="col-sm-2 control-label">路径</label>
							<div class="input-group col-sm-6">
								<input type="text" class="form-control" placeholder="" id="path_input" name="path" required="required">
								<span class="input-group-btn">
									<button type="button" class="btn btn-purple btn-sm" data-toggle="modal" data-target="#browser">
										<span class="ace-icon fa fa-search icon-on-right bigger-110"></span>
										浏览
									</button>
								</span>
							</div>
						</div>
						<div class="form-group">
						    <div class="col-sm-offset-2 col-sm-10">
						      <button type="submit" class="btn btn-default" id="import_btn">导入</button>
						    </div>
						</div>
					</form>
					
					<div class="alert alert-danger" role="alert" th:if="${createTask == false}">创建失败</div>
				</div>
				
				<div class="col-sm-6" th:if="${task != null}" id="current_task">
					<h3>当前任务</h3>
					
					<div id="task_container">
						<div class="panel panel-default">
							<div class="panel-heading" th:text="${task.taskId}">任务名</div>
							<div class="list-group">
								<div class="list-group-item">
									<h6><span id="task_progress_info" th:text="|进度  (${task.progress}/${task.total})， 失败:${task.error}个|">(/)</span></h6>
									<div class="progress pos-rel progress-large" id="task_progress" data-percent="66%" th:data-percent="${#numbers.formatPercent(task.progress*1f/task.total, 0, 2)}">
										<div class="progress-bar progress-bar-striped active" th:style="|width: ${task.progress*100f/task.total}%;|"></div>
									</div>
								</div>
								<div class="list-group-item">
									<div class='row'>
										<div class="col-sm-12">
											<span class="col-sm-2">启动者</span>
											<span class="col-sm-6" th:text="${task.creator}">admin</span>
										</div>
										<div class="col-sm-12">
											<span class="col-sm-2">开始时间</span>
											<span class="col-sm-6" th:text="${#calendars.format(task.createTime,'MM-dd HH:mm:ss')}">time</span>
										</div>
										<div class="col-sm-12">
											<span class="col-sm-2">文件路径</span>
											<span class="col-sm-6" th:text="${task.filePath}">dir</span>
										</div>
										<div class="col-sm-12">
											<span class="col-sm-2">人脸库</span>
											<span class="col-sm-6" th:text="${task.faceSet.name}">admin</span>
										</div>
									</div>
								</div>
								<div class="list-group-item">
									<h6>日志</h6>
									<div id="log_container">
									</div>
								</div>
							</div>
						</div>
						<div id="new_task" th:hidden="${task.status!=2}">
							<button class="btn btn-primary">新导入</button>
						</div>
					</div>
					
					<script type="text/javascript" th:inline="javascript">
					
						$('#new_task').click(function(e){
							$('#current_task').hide();
							$('#new_task_form').show();
						});
						
						$('#log_container').ace_scroll({size: 200});
						
						var socket = new WebSocket('ws://'+window.location.host+'/client');
					    var stompClient = Stomp.over(socket);
					    
					    stompClient.connect({}, function(frame){
					    	
					    	stompClient.subscribe('/w/task/'+[[${task.taskId}]], function(message){
					    		var task = JSON.parse(message.body);
					    		var progress = (task.progress*100/task.total).toFixed(2) +'%';
					    		//$("#task_progress").data('percent', progress);
					    		
					    		
					    		var cost = formatCostTime(costTime(task.costTime));
					    		
					    		var leftTime = Math.floor(task.costTime / task.progress * (task.total - task.progress));
					    		
					    		var left = formatCostTime(costTime(leftTime));
					    		
					    		var info = "进度  ("+task.progress+"/"+task.total+")， 失败:"+task.error+"个。 已用时:"+cost+"， 预计剩余时间: "+left;
					    		
					    		
					    		$('#task_progress_info').text(info);
					    		
					    		$("#task_progress").attr('data-percent',progress);
					    		$("#task_progress .progress-bar").css('width', progress);
					    		$('#log_container').ace_scroll('end');
					    		if(task.status == 2){
					    			progress_done();
					    		}
					    	});
					    	
					    	stompClient.subscribe('/w/tasklog/'+[[${task.taskId}]], function(message){
								$('#log_container .scroll-content').append($('<br>')).append($('<span>').text(message.body));
					    	});
					    });
					    
					    function progress_done(){
					    	$('#new_task').show();
					    	$("#task_progress .progress-bar").removeClass('active').removeClass('progress-bar-striped').addClass('progress-bar-success');
					    }
					    
					    function costTime(cost){
					    	var sec = cost%60;
					    	var m = Math.floor(cost/60);
					    	var min = m%60;
					    	var h = Math.floor(m/60);
					    	var hour = h%24;
					    	var day = Math.floor(h/24);
					    	
					    	return {
					    		day: day,
					    		hour: hour,
					    		min: min,
					    		sec: sec
					    	}
					    }
					    
					    function formatCostTime(time){
					    	var s="";
					    	if(time.day>0){
					    		s+=time.day+"天"
					    	}
					    	if(time.hour>0){
					    		s+=time.hour+"小时"
					    	}
					    	if(time.min>0){
					    		s+=time.min+"分钟"
					    	}
					    	s+=time.sec+"秒";
					    	return s;
					    }
					    
					</script>
					
					<script type="text/javascript" th:if="${task.status} ==2">
						progress_done();
					</script>
					
				</div>
			</div>
			
			<!-- <div>
				<div class="row">
					<div class="col-xs-3">
						任务名
					</div>
					<div class="col-xs-6">
						<div class="progress pos-rel" data-percent="66%">
							<div class="progress-bar" style="width:66%;"></div>
						</div>
					</div>
					<div class="col-xs-3">
						1000/10000
					</div>
				</div>
			</div> -->
			
			<!-- Modal -->
			<div class="modal fade" id="browser" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			        <h4 class="modal-title" id="browserModalLabel">选择批量导入文件路径</h4>
			      </div>
			      <div class="modal-body" style="max-height: 690px;">
					    <div class="form-group">
					        <div class="form-group-cell root-select-cell" style="width: 100px">
					            <label>磁盘:</label>
					            <select id="disk">
					            </select>
					        </div>
					        <div class="form-group-cell folder-select-cell" style="width: 350px">
					            <label class="ng-binding">路径</label>
					            <input type="text" autocomplete="off" id="path">
					        </div>
					        <div class="form-group-cell form-button form-link">
					            <a href="" class="up-folder" id="up-folder">
					                <i class="ace-icon fa fa-level-up bigger fa-2x"></i>
					            </a>
					        </div>
					    </div>
						<input type="hidden" id="current_folder_path" value="">
					    <div class="browse-container" id="browse-container">
					        <div class="browse-item-row" tabindex="0">
					            <div class="file-wrapper browse-item">
					                <span class="icon"><i class="menu-icon fa fa-folder-open-o"></i></span>
					                <span class="path" data-path="">dir</span>
					            </div>
					        </div>
					    </div>
					</div>
			      <div class="modal-footer">
			        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			        <button type="button" class="btn btn-primary" id="path_select_btn">选择</button>
			      </div>
			    </div>
			  </div>
			</div>
			<script type="text/javascript">
				$(function(){
					
					$.getJSON('/faceset/face',function(json){
						for(var faceset of json.faceSets){
							$('select[name="faceSetToken"]').append(
									$("<option>",{
										value: faceset.token
									}).text(faceset.name)
							);
						}
					});
					
					
					/* $('#import_btn').click(function(e){
						var data = $('#import_form').serializeArray();
						$.ajax({
	               			url: '/faceset/createTask',
	               			data: data,
	               		    type: 'POST',
	               		    dataType:"text",
	               		    success: function(result) {
	               		    	if(result != null){
	               		    		$.alert({
	            		    		    title: '提示',
	            		    		    content: '创建成功',
	            		    		});
	               		    	}
	               		    	else {
	               		    		$.alert({
	            		    		    title: '提示',
	            		    		    content: '添加失败',
	            		    		});
	               		    	}
	               		    }
               		  });
					}) */
					
					
					$(".browse-container").on("click", ".browse-item-row", function(e){
						$(".browse-item-row").removeClass('selected');
						$(this).addClass('selected');
						var path = $(this).find(".path").data('path');
						$("#path").val(path);
					})
					
					$(".browse-container").on("dblclick", ".browse-item-row", function(e){
						var path = $(this).find(".path").data('path');
						listDir(path);
					})
					
					$("#disk").change(function(e){
						listDir($(this).val());
						$("#path").val("");
					});
					
					$("#up-folder").click(function(e){
						e.preventDefault();
						var current_folder = $('#current_folder_path').val();
						if(isRoot(current_folder)){
							return;
						}
						var parent = current_folder.substring(0,current_folder.lastIndexOf("\\"));
						listDir(parent);
						if(isRoot(parent)){
							$("#path").val("");
						}else{
							$("#path").val(parent);
						}
					});
					
					$('#path_select_btn').click(function(e){
						$('#path_input').val($('#path').val());
						$('#browser').modal('hide');
					});
					
					function isRoot(path){
						if(path.indexOf("\\") == -1){
							return true;
						}
						var path_ary = path.split("\\");
						if(path_ary.length == 1 || path_ary[1] == ""){
							return true;
						}
						return false;
					}
					
					$.getJSON("diskRoot", function(json){
						$("#disk").empty();
						for(var disk of json){
							$("#disk").append($('<option>', {
			                    value: disk
			              }).text(disk));
						}
						
						$("#disk").trigger('change');
					});
					
					
					
					function listDir(folder){
						$.getJSON("listDir", {parent: folder}, function(json){
							$('#current_folder_path').val(folder);
							$("#browse-container").empty();
							for(var dir of json){
								$("#browse-container").append(
									$('<div>', {
										'class': "browse-item-row",
										tabindex: "0"
					              	}).append(
					              		$('<div>', {
											'class': "file-wrapper browse-item"
						              	}).append(
						              		$('<span>', {'class':'icon'}).append($('<i>', {'class': "menu-icon fa fa-folder-open-o"}))		
						              	).append(
						              		$('<span>', {
						              			'class': 'path',
						              			'data-path': dir
						              		}).text(dir.substring(dir.lastIndexOf("\\")+1))
						              	)
						            )
								);
							}
							
							if(isRoot(folder)){
								$("#up-folder").addClass("disabled");
							}
						})
					}
					
				})
			</script>
		</div>
		
	</html>	
